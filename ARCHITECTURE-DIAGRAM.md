# 架構圖與數據流

## 1️⃣ 插件整體架構

```
┌─────────────────────────────────────────────────────┐
│              Chrome Extension (MV3)                  │
│                                                     │
│  ┌──────────────────────────────────────────────┐  │
│  │         manifest.json                        │  │
│  │  - 權限配置 (clipboardRead/Write, storage)  │  │
│  │  - 背景腳本、內容腳本註冊                    │  │
│  │  - Popup 和選項頁面                         │  │
│  └──────────────────────────────────────────────┘  │
│                                                     │
│  ┌──────────────────────────────────────────────┐  │
│  │         background.js (Service Worker)       │  │
│  │                                              │  │
│  │  ┌────────────────────────────────────────┐ │  │
│  │  │ URL_RULES (規則定義)                  │ │  │
│  │  │ - keepParams: 只保留指定參數           │ │  │
│  │  │ - removeParams: 移除指定參數           │ │  │
│  │  │ - pathTransform: 路徑轉換             │ │  │
│  │  │ - 通用規則 (*): 所有網站套用           │ │  │
│  │  └────────────────────────────────────────┘ │  │
│  │                                              │  │
│  │  ┌────────────────────────────────────────┐ │  │
│  │  │ cleanURL() 函數                        │ │  │
│  │  │ 1. 解析 URL                           │ │  │
│  │  │ 2. 查找適用規則                       │ │  │
│  │  │ 3. 執行路徑轉換 (if pathTransform)   │ │  │
│  │  │ 4. 應用 keepParams 或 removeParams   │ │  │
│  │  │ 5. 回傳清理後的 URL                   │ │  │
│  │  └────────────────────────────────────────┘ │  │
│  │                                              │  │
│  │  ┌────────────────────────────────────────┐ │  │
│  │  │ chrome.runtime.onMessage 監聽器        │ │  │
│  │  │ - 接收 action: 'cleanURL'              │ │  │
│  │  │ - 回傳清理後的 URL                     │ │  │
│  │  └────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────┘  │
│                           ↑                        │
│                    (訊息通道)                      │
│                           ↓                        │
│  ┌──────────────────────────────────────────────┐  │
│  │        content.js (Content Script)           │  │
│  │                                              │  │
│  │  ┌────────────────────────────────────────┐ │  │
│  │  │ initClipboardMonitoring()              │ │  │
│  │  │ - 監聽 copy 事件                       │ │  │
│  │  │ - 輪詢剪貼簿 (500ms 間隔)              │ │  │
│  │  │ - 自動清理 URL                        │ │  │
│  │  └────────────────────────────────────────┘ │  │
│  │                                              │  │
│  │  ┌────────────────────────────────────────┐ │  │
│  │  │ initBubble()                           │ │  │
│  │  │ - 浮動氣泡 UI                         │ │  │
│  │  │ - 拖曳 & 位置記憶                      │ │  │
│  │  │ - 單擊/雙擊處理                        │ │  │
│  │  │ - Alt+C 快捷鍵                         │ │  │
│  │  └────────────────────────────────────────┘ │  │
│  │                                              │  │
│  │  ┌────────────────────────────────────────┐ │  │
│  │  │ showNotification()                     │ │  │
│  │  │ - 顯示成功/失敗訊息                    │ │  │
│  │  └────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────┘  │
│                                                     │
│  ┌──────────────────────────────────────────────┐  │
│  │      popup.html / popup.js / popup.css       │  │
│  │      - 簡單的浮動氣泡開關                    │  │
│  │      - 點擊複製當前頁面網址                  │  │
│  └──────────────────────────────────────────────┘  │
│                                                     │
│  ┌──────────────────────────────────────────────┐  │
│  │    options.html / options.js / options.css   │  │
│  │    - 完整設定頁面                           │  │
│  │    - 浮動氣泡開關                          │  │
│  │    - 通知訊息開關                          │  │
│  └──────────────────────────────────────────────┘  │
│                                                     │
│  ┌──────────────────────────────────────────────┐  │
│  │      chrome.storage.local                    │  │
│  │      {                                       │  │
│  │        settings: {                           │  │
│  │          showBubble: boolean,                │  │
│  │          showNotifications: boolean          │  │
│  │        },                                    │  │
│  │        bubblePositions: {                    │  │
│  │          'domain.com': {x, y, timestamp}    │  │
│  │        }                                     │  │
│  │      }                                       │  │
│  └──────────────────────────────────────────────┘  │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

## 2️⃣ URL 清理流程

### 用戶複製 URL 時的自動清理

```
┌─────────────────────────────────────────────┐
│      用戶複製 URL (Ctrl+C)                  │
│  例: https://example.com/page?id=123       │
│                    &utm_source=facebook      │
│                    &fbclid=xyz              │
└────────────┬────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────┐
│   content.js: document.copy 事件監聽器       │
│   - 取得複製的文字 (selection)              │
│   - 檢查是否為 URL                         │
└────────────┬────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────┐
│ content.js: chrome.runtime.sendMessage()    │
│ - action: 'cleanURL'                        │
│ - url: 原始 URL                            │
└────────────┬────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────┐
│   background.js: onMessage 監聽器            │
│   - 接收訊息                                │
│   - 呼叫 cleanURL()                        │
└────────────┬────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────┐
│      cleanURL() 函數執行                    │
│                                             │
│  1. new URL(urlString)                     │
│     └─> URL 物件                           │
│                                             │
│  2. 取得 hostname                          │
│     └─> 例: 'example.com'                  │
│                                             │
│  3. 查找 URL_RULES[hostname]                │
│     └─> 找不到則用 URL_RULES['*']          │
│                                             │
│  4. 條件判斷:                               │
│     ├─> rule.pathTransform? 執行轉換       │
│     ├─> rule.keepParams? 保留模式          │
│     └─> rule.removeParams? 移除模式        │
│                                             │
│  5. keepParams 模式 (例: ['id'])           │
│     ├─> new URLSearchParams()              │
│     ├─> 遍歷 keepParams 陣列                │
│     ├─> 只保留指定參數                     │
│     └─> url.search = newParams.toString() │
│                                             │
│  6. removeParams 模式                      │
│     ├─> 遍歷 removeParams 陣列              │
│     ├─> url.searchParams.delete(param)    │
│     ├─> 同時套用通用規則 (*)               │
│     └─> 移除通用追蹤參數                   │
│                                             │
│  7. 回傳清理後的 URL                        │
│     └─> url.toString()                    │
│                                             │
└────────────┬────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────┐
│ background.js: sendResponse()               │
│ - cleanedURL: 清理後的 URL                 │
└────────────┬────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────┐
│ content.js: 接收清理結果                    │
│ - 比較原始與清理 URL 是否不同               │
│ - 如果不同，寫入剪貼簿                      │
│ - 顯示通知訊息                             │
└────────────┬────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────┐
│   navigator.clipboard.writeText()           │
│   - 將清理後的 URL 放入剪貼簿               │
│                                             │
│   清理後: https://example.com/page?id=123  │
└─────────────────────────────────────────────┘
```

---

## 3️⃣ 浮動氣泡互動流程

```
┌────────────────────────────────────────────┐
│       用戶操作浮動氣泡                      │
└────┬──────────────────────────────┬────────┘
     │                              │
     ▼                              ▼
┌────────────────┐        ┌────────────────┐
│  單擊          │        │  雙擊          │
│  (hasMoved=0)  │        │  (dblclick)    │
└────────┬───────┘        └────────┬───────┘
         │                         │
         ▼                         ▼
    複製當前頁面      複製原始頁面 URL
    清理後的 URL      (不清理)
         │                         │
         └────────────┬────────────┘
                      │
                      ▼
         ┌─────────────────────────┐
         │ chrome.runtime.         │
         │ sendMessage()           │
         │ action: 'cleanURL'      │
         └────────────┬────────────┘
                      │
                      ▼
         ┌─────────────────────────┐
         │ background.js           │
         │ cleanURL()              │
         └────────────┬────────────┘
                      │
                      ▼
         ┌─────────────────────────┐
         │ copyToClipboard()       │
         │ - 視覺反饋 (閃爍)       │
         │ - 顯示通知              │
         └─────────────────────────┘


┌────────────────────────────────────────────┐
│       拖曳氣泡                              │
│  (hasMoved > 5px)                          │
└────────────┬─────────────────────────────┘
             │
             ▼
    更新氣泡位置 (currentX, currentY)
    限制在視窗範圍內
             │
             ▼
    滑鼠鬆開時 savePosition()
             │
             ▼
    chrome.storage.local.set({
      bubblePositions: {
        'current.domain': {x, y, timestamp}
      }
    })


┌────────────────────────────────────────────┐
│       鍵盤快捷鍵 (Alt + C)                   │
└────────────┬─────────────────────────────┘
             │
             ▼
    與單擊氣泡相同流程
```

---

## 4️⃣ URL_RULES 規則優先級

```
輸入 URL: https://youtube.com/watch?v=ABC123&si=XYZ&list=PLxxx

             ▼
   ┌──────────────────────────┐
   │ 查找 URL_RULES['youtube.com'] │
   └────────────┬─────────────┘
                │
      ┌─────────┴─────────┐
      ▼                   ▼
   有定義規則?         規則類型?
      │                   │
      │          ┌────────┼────────┐
      │          ▼        ▼        ▼
      │      keepParams removeParams pathTransform
      │          │        │        │
      │          │        │        │
      │          ▼        ▼        ▼
      │    只保留  移除+    路徑轉換
      │    指定    通用    並清理參數
      │    參數    規則    參數
      │          │        │
      │    [v, list]  [specific]  
      │          │        │
      │          ▼        ▼
      │    新 URL:    清理後 URL:
      │    ?v=ABC123  (移除 si)
      │    &list=PLxxx
      │
      └──────────┬────────┘
                 │
                 ▼
         ┌──────────────────┐
         │ 如果沒有特定規則 │
         │ 使用 URL_RULES['*'] │
         │ (通用規則)       │
         └────────┬─────────┘
                  │
                  ▼
         移除 40+ 通用追蹤參數
         (utm_*, fbclid, gclid...)
                  │
                  ▼
         清理後 URL
```

---

## 5️⃣ 蝦皮 URL 轉換特殊流程

```
蝦皮原始 URL:
https://shopee.tw/商品名-i.12345.67890?utm_source=...&utm_campaign=...
                                 ├─ shopId: 12345
                                 └─ productId: 67890

             ▼

┌─────────────────────────────────────┐
│ URL_RULES['shopee.tw']              │
│ {                                   │
│   pathTransform: true,              │
│   keepParams: []                    │
│ }                                   │
└────────────┬────────────────────────┘
             │
             ▼

┌─────────────────────────────────────┐
│ cleanURL() 檢查:                    │
│ rule.pathTransform && hostname === │
│ 'shopee.tw'                         │
└────────────┬────────────────────────┘
             │
             ▼

┌─────────────────────────────────────┐
│ transformShopeeURL(url)             │
│                                     │
│ 正則匹配: /-i\.(\d+)\.(\d+)/       │
│ 匹配: -i.12345.67890                │
│ shopId = 12345                      │
│ productId = 67890                   │
│                                     │
│ url.pathname = `/product/12345/     │
│                67890`               │
└────────────┬────────────────────────┘
             │
             ▼

┌─────────────────────────────────────┐
│ 應用 keepParams: [] (空陣列)        │
│ - 移除所有查詢參數                  │
│ - 保留路徑轉換後的結果              │
└────────────┬────────────────────────┘
             │
             ▼

清理後 URL:
https://shopee.tw/product/12345/67890
```

---

## 6️⃣ Chrome Storage 數據結構

```
chrome.storage.local = {
  ┌─────────────────────────────────────┐
  │ settings: {                         │
  │   showBubble: true,                 │
  │   showNotifications: true           │
  │ }                                   │
  └─────────────────────────────────────┘
  
  ┌─────────────────────────────────────┐
  │ bubblePositions: {                  │
  │   'github.com': {                   │
  │     x: 1234,                        │
  │     y: 567,                         │
  │     timestamp: 1704000000000        │
  │   },                                │
  │   'youtube.com': {                  │
  │     x: 456,                         │
  │     y: 789,                         │
  │     timestamp: 1704000000000        │
  │   },                                │
  │   'facebook.com': {                 │
  │     x: 100,                         │
  │     y: 200,                         │
  │     timestamp: 1704000000000        │
  │   }                                 │
  │ }                                   │
  └─────────────────────────────────────┘
}
```

每個網域記憶一個位置，用戶下次訪問時浮動氣泡會出現在記憶的位置。

---

## 7️⃣ 訊息傳遞時序圖

```
              Content Script              Background Script
              (content.js)                 (background.js)

用戶複製 URL
    │
    ├─> copy 事件觸發
    │
    ├─> 取得選取文字 ✓
    │
    ├─> 檢查是 URL? ✓
    │
    ├─────────────── sendMessage ──────────────────>│
    │                                                │
    │  {                                            │
    │    action: 'cleanURL',                       │
    │    url: 'https://...'                        │
    │  }                                            │
    │                                            │──┤ onMessage
    │                                            │  │ 監聽器
    │                                            │──┤
    │                                            │  │
    │                                            │──┤ cleanURL()
    │                                            │  │ 執行
    │                                            │──┤
    │                                         │<─────
    │ sendResponse({                            │
    │   cleanedURL: '清理後'                   │
    │ })                                        │
    │
    ├─> 比較 URL 是否改變 ✓
    │
    ├─> navigator.clipboard.writeText() ✓
    │
    └─> showNotification() ✓
```

---

**備註**: 此架構圖基於 v1.3.4 版本，具體實現細節可能會隨版本更新而改變。

