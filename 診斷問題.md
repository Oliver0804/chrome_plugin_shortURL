# 🔍 Bilibili URL 清理問題診斷指南

## 問題描述
使用 B 站的「點即複製連結」按鈕後，複製的 URL 仍包含追蹤參數，未被自動清理。

## 🛠️ 診斷步驟

### 步驟 1：確認擴充功能已重新載入 ⭐ 最重要

1. 打開 `chrome://extensions/`
2. 找到 **Short URL Copier**
3. 點擊 🔄 **重新載入** 按鈕（右下角的圓形箭頭圖標）
4. 確認版本號顯示為 **1.3.5**

**如果沒有重新載入，修改的程式碼不會生效！**

---

### 步驟 2：檢查剪貼簿權限

1. 打開任意 Bilibili 頁面（例如：https://www.bilibili.com/video/BV1pWnJzcEeU/）
2. 按 **F12** 打開開發者工具
3. 切換到 **Console** 分頁
4. 執行以下指令：

```javascript
// 測試剪貼簿讀取權限
navigator.clipboard.readText()
  .then(text => console.log('✅ 剪貼簿權限正常，內容:', text))
  .catch(err => console.error('❌ 剪貼簿權限錯誤:', err));
```

**預期結果：**
- 如果顯示 `✅ 剪貼簿權限正常`：權限正常
- 如果顯示 `❌ 剪貼簿權限錯誤`：需要授予權限

---

### 步驟 3：檢查 Content Script 是否載入

在 Console 中執行：

```javascript
// 檢查 Content Script 是否已載入
console.log('Short URL Copier 注入狀態:', window.shortURLCopierInjected);
```

**預期結果：**
- 應該顯示 `true`
- 如果顯示 `undefined`，表示 Content Script 沒有載入

**解決方法：**
1. 重新整理頁面（F5）
2. 檢查擴充功能是否已啟用

---

### 步驟 4：手動測試 URL 清理功能

在 Console 中執行：

```javascript
// 測試 URL 清理
chrome.runtime.sendMessage(
  {
    action: 'cleanURL',
    url: 'https://www.bilibili.com/video/BV1pWnJzcEeU/?share_source=copy_web&vd_source=750a73dce5b20764cb3b69f12be39ec6'
  },
  (response) => {
    console.log('原始 URL:', 'https://www.bilibili.com/video/BV1pWnJzcEeU/?share_source=copy_web&vd_source=750a73dce5b20764cb3b69f12be39ec6');
    console.log('清理後 URL:', response.cleanedURL);
    console.log('是否清理成功:', response.cleanedURL === 'https://www.bilibili.com/video/BV1pWnJzcEeU/');
  }
);
```

**預期結果：**
```
原始 URL: https://www.bilibili.com/video/BV1pWnJzcEeU/?share_source=copy_web&vd_source=750a73dce5b20764cb3b69f12be39ec6
清理後 URL: https://www.bilibili.com/video/BV1pWnJzcEeU/
是否清理成功: true
```

---

### 步驟 5：檢查剪貼簿監聽日誌

在 Console 中查看是否有以下日誌訊息：

```
🚀 Short URL Copier: Content Script 開始載入
✓ Short URL Copier: 設定注入標記
📋 Short URL Copier: 開始初始化剪貼簿監聽
✓ 剪貼簿監聽已啟用（始終運作）
🔍 啟用剪貼簿輪詢監聽
```

**如果看不到這些訊息：**
- 表示 Content Script 沒有正確載入
- 需要重新載入擴充功能並重新整理頁面

---

### 步驟 6：實際測試複製功能

1. 清空剪貼簿（複製任意其他文字）
2. 在 Bilibili 頁面點擊「複製連結」按鈕
3. 等待 1-2 秒（剪貼簿監聽每 500ms 檢查一次）
4. 在任意地方貼上

**預期結果：**
- 應該看到通知訊息：「✓ 已自動清理剪貼簿網址！」
- 貼上的 URL 應該是乾淨的（無追蹤參數）

---

## 🐛 常見問題與解決方案

### 問題 1：擴充功能沒有重新載入
**症狀：** 修改程式碼後沒有效果
**解決：**
1. 前往 `chrome://extensions/`
2. 點擊 Short URL Copier 的重新載入按鈕
3. 重新整理 Bilibili 頁面

---

### 問題 2：剪貼簿權限被拒絕
**症狀：** Console 顯示權限錯誤
**解決：**
1. 點擊網址列左側的 🔒 或 ⓘ 圖示
2. 找到「剪貼簿」權限
3. 設定為「允許」
4. 重新整理頁面

---

### 問題 3：Content Script 沒有載入
**症狀：** `window.shortURLCopierInjected` 顯示 undefined
**解決：**
1. 檢查 manifest.json 中的 content_scripts 設定
2. 確認 `"matches": ["<all_urls>"]` 存在
3. 重新載入擴充功能
4. 重新整理頁面

---

### 問題 4：剪貼簿監聽延遲
**症狀：** 複製後需要等待才會清理
**說明：** 這是正常的，剪貼簿輪詢每 500ms 檢查一次
**解決：** 複製後等待 1-2 秒即可

---

## 📝 快速檢查清單

完成後打勾：

- [ ] 擴充功能已重新載入（版本 1.3.5）
- [ ] 剪貼簿權限已授予
- [ ] Content Script 已載入（`window.shortURLCopierInjected === true`）
- [ ] 手動測試 URL 清理成功
- [ ] Console 有看到剪貼簿監聽日誌
- [ ] 實際複製測試成功

---

## 🆘 如果以上都無法解決

請提供以下資訊：

1. **Console 中的所有日誌訊息**（特別是紅色錯誤）
2. **手動測試 URL 清理的結果**（步驟 4）
3. **擴充功能版本號**
4. **Chrome 版本**（在 `chrome://version/` 查看）

這樣我才能更精確地找出問題所在。
